<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Member</title>
    <link rel="stylesheet" href="/static/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <script src="/static/navbar.js" defer></script>
    <script src="https://unpkg.com/@popperjs/core@2" defer></script>
    <script src="https://unpkg.com/tippy.js@6" defer></script>
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/material.css"/>
</head>
<body class="page-member">
    <dialog class="dialog" id="dialog">
        <div class="login-container" id="login-container">
            <div class="close-btn" id="close-btn-login">
                <img src="/static/icon/icon_close.png" alt="關閉對話框" width="16px" height="16px">
            </div>
            <h3>登入會員帳號</h3>
            <div>
                <form id="sign-in">
                    <input type="email" name="email" 
                            placeholder="輸入電子信箱" 
                            pattern="[a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+.[a-zA-Z]{2,}"
                            title="請輸入有效的電子信箱格式"
                            required>
                    <input type="password" name="password" placeholder="輸入密碼" required>
                    <button type="submit">登入帳戶</button>
                    <p id="loginMessage" style="display: none"></p>
                    <p><a href="#" id="switch-to-register">還沒有帳戶？點此註冊</a></p>
                </form>
            </div>
        </div>
        <div class="register-container" id="register-container">
            <div class="close-btn" id="close-btn-register">
                <img src="/static/icon/icon_close.png" alt="關閉對話框" width="16px" height="16px">
            </div>
            <h3>註冊會員帳號</h3>
            <div>
                <form id="sign-up">
                    <input type="text" name="name" 
                            placeholder="輸入姓名"
                            pattern="^\S.*\S$"
                            title="姓名前後不可包含空格"
                            required>
                    <input type="email" name="email" 
                            placeholder="輸入電子郵件" 
                            pattern="[a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+.[a-zA-Z]{2,}"
                            title="請輸入有效的電子郵件格式"
                            required>
                    <input type="password" name="password" 
                            placeholder="輸入密碼" 
                            pattern="^\S+$"
                            title="密碼不可包含空格"
                            required>
                    <button type="submit">註冊新帳戶</button>
                    <p id="registerMessage" style="display: none"></p>
                    <p><a href="#" id="switch-to-login">已經有帳戶了？點此登入</a></p>
                </form>
            </div>
        </div>
    </dialog>
    <div class="navbar">
        <div class="nav-text">
            <h2><a href="/">台北一日遊</a></h2>
            <div class="nav-list" id="navList" style="display: none">
                <p id="memberBtn">會員中心</p>
                <p id="bookingBtn">預定行程</p>
                <p id="loginBtn" style="display: none">登入/註冊</p>
                <p id="logoutBtn" style="display: none">登出系統</p>
            </div>
        </div>
    </div>
    <div class="container-account">
        <div class="title">
            <h1>帳號管理</h1>
            <p>查看所有訂單並管理您的帳戶資訊</p>
        </div>
        <div class="account-overview">
            <div class="orderlist">
                <p>Orders</p>
                <div id="orders-container"></div>
            </div>
            <div class="member-info">
                <p>Member</p>
            </div>
        </div>
    </div>
    <dialog id = "orderDialog">
        <div class="close-btn" id="close-btn-login">
            <img src="/static/icon/icon_close.png" alt="關閉對話框" width="16px" height="16px">
        </div>
        <div id="dialogContent"></div>
    </dialog>
  
    <div class="footer" id="footer">
        <p>COPYRIGHT © 2021 台北一日遊</p>
    </div>
    
</body>
<script>

    const ordersContainer = document.getElementById("orders-container");

    async function fetchOrders() {
        const token = localStorage.getItem("jwt_token");

        // 顯示 Loading 動畫
        ordersContainer.innerHTML = "";
        let loading = document.createElement("p");
        loading.textContent = "載入中...";
        loading.id = "loading";
        ordersContainer.appendChild(loading);

        try {
            let response = await fetch("/api/order", {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${token}`
                }
            });

            let result = await response.json();
            let orders = result.data;

            // 移除 Loading
            loading.remove();

            if (response.status === 403) {
                alert("錯誤訊息:" + orders.message);
                window.location.href = "/";
            } else if (response.status === 200) {
                // console.log("orders:", orders)
                renderOrders(orders);
            } else {
                alert("錯誤訊息:" + orders.message);
            }

        } catch (error) {
            console.error("取得訂單資料失敗：", error);
            loading.remove(); // 移除 loading
            const errMsg = document.createElement("p");
            errMsg.textContent = "無法載入訂單資料，請稍後再試。";
            document.getElementById("orders-container").appendChild(errMsg);
        }
    }


    function renderOrders(orders) {
        if (!orders || orders.length === 0) {
                let noData = document.createElement("p");
                noData.textContent = "目前尚無訂單紀錄";
                ordersContainer.appendChild(noData);
                return;
            }

            let table = document.createElement("table");

            // 表頭 
            let thead = document.createElement("thead");
            let headerRow = document.createElement("tr");
            let headers = ["序號","訂單編號","景點名稱","行程日期","時段","付款狀態"];
            let widths = ["45px", "175px", "310px", "95px", "85px", "75px"];
            let titleMap = {
                "時段": "上半天：09:00～16:00<br>下半天：14:00～21:00"
            }

            headers.forEach((headerText, index) => {
                let th = document.createElement("th");
                th.textContent = headerText;
                th.style.width = widths[index];

                if (titleMap[headerText]) {
                    // console.log(`Setting title for ${headerText}: ${titleMap[headerText]}`); 
                    tippy(th, {
                        content: titleMap[headerText],
                        allowHTML: true,
                        placement: "top",
                        arrow: true,
                        theme: "material",
                        animation: "shift-away",
                        onShow(instance) {
                            instance.reference.style.cursor = "help";
                        }
                    })
                }

                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // 表身
            let tbody = document.createElement("tbody");

            orders.forEach((order, index) => {
                let row = document.createElement("tr");
                let timeMap = {
                    morning: "上半天",
                    afternoon: "下半天"
                };
                let statusMap = {
                    PAID: "已付款",
                    UNPAID: "尚未付款"
                };

                let timeText = timeMap[order.dateTime] || order.dateTime;
                let statusText = statusMap[order.paymentStatus] || order.paymentStatus;


                let data = [index+1, order.order_number, order.name, order.tourDate, timeText, statusText];

                data.forEach(value => {
                    let td =document.createElement("td");
                    td.textContent = value;

                    if (statusText === "尚未付款") {
                        td.style.color = "#CE0000";
                    }

                    row.appendChild(td)
                });
                tbody.appendChild(row);
            });

            table.appendChild(tbody);
            ordersContainer.appendChild(table);
    }





    document.addEventListener("DOMContentLoaded", async function () {
        const isLoggedIn = await checkUserStatus();
        if (!isLoggedIn) {
            window.location.href = "/";
            return;            
        } 
        fetchOrders();
        
    })    
</script>
</html>